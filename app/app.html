<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        #init{
            display:flex;
            height:300px;
            justify-content: center;
            align-items: center;
        }
        #output{
            border: 1px solid black;
            padding: 10px 0px 5px 5px;
            height: 100px;
            overflow-y: auto;
        }
        #msgbox{
            padding: 2px 4px;
            background: black;
            color:white;
            border-radius: 10%;
            opacity:0;
        }
        .showmsg{
            animation-name: ease-in-out;
            animation-duration: 1s;
            animation-timing-function: linear;
        }
        @keyframes ease-in-out {
            0%   {opacity:0}
            20%  {opacity:1}
            50%  {opacity:1}
            100% {opacity:0}
        }
    </style>
</head>
<body>
<div id="init" style="visibility: hidden">
    <div>
        <img src="icon.png" />
        <p data-i18n="p_init">Initiating...</p>
        <p data-i18n="p_taketime">It may take several seconds.</p>
    </div>
</div>
<div id="demo" style="display: none">
    <label data-i18n="lbl_oritext">Original Text:</label>
    <div>
        <textarea id="oritext" style="font-size:11pt;width:100%;resize: none;" rows="6">感じ取れたら手を繋ごう、重なるのは人生のライン and レミリア最高！</textarea>
    </div>
    <label data-i18n="lbl_convertto">Convert to </label>
    <select id="to" name="to" tabindex="2">
        <option value="hiragana" selected="" data-i18n="opt_hiragana">Hiragana</option>
        <option value="katakana" data-i18n="opt_katakana">Katakana</option>
        <option value="romaji" data-i18n="opt_romaji">Romaji</option>
    </select>
    <label data-i18n="lbl_withmode">with mode </label>
    <select id="mode" name="mode" tabindex="1">
        <option value="normal" selected="" data-i18n="opt_normal">Normal</option>
        <option value="spaced" data-i18n="opt_spaced">Spaced</option>
        <option value="okurigana" data-i18n="opt_okurigana">Okurigana</option>
        <option value="furigana" data-i18n="opt_furigana">Furigana</option>
    </select>

    <button onclick="convert()" data-i18n="btn_convert">Convert</button>
    <div style="margin: 10px 0">
        <div>
            <label data-i18n="lbl_result">Result:</label>
            <div id="output" style="width:100%" rows="6" readonly="readonly"></div>
        </div>
        <div  style="margin: 5px 0 5px 0;">
            <button onclick="copytoclip()" style="z-index: 100;margin-right:2px" data-i18n="btn_copytoclip">Copy To Clipboard</button>
            <button onclick="savetofile()" style="z-index: 100" data-i18n="btn_savetofile">Save To File</button>
            <span id="msgbox" style="float:right"></span>
        </div>
    </div>
</div>
<script src="bower_components/kuroshiro/dist/browser/kuroshiro.min.js"></script>
<script>
    const clipboard = require('electron').clipboard;
    const remote = require('remote');
    const dialog = remote.require('dialog');
    const fs = require('fs');

    var i18n;
    var locale = (navigator.language && navigator.language.replace(/-/,'_')) || 'en_US';

    function initI18N(){
        var targets = document.querySelectorAll('[data-i18n]');
        for(var i=0;i<targets.length;i++){
            if(i18n[targets[i].dataset.i18n])
                targets[i].innerHTML = i18n[targets[i].dataset.i18n];
        }
        document.getElementById("init").setAttribute("style","");
        kuroshiro.init(function(){
            document.getElementById("init").setAttribute("style","display:none");
            document.getElementById("demo").setAttribute("style","display:block");
        });
    }

    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange=function()
    {
        if (xhr.readyState==4){
            if(xhr.status==200){
                i18n = JSON.parse(xhr.responseText);
                initI18N();
            }else{
                var xhr2 = new XMLHttpRequest();
                xhr2.onreadystatechange=function()
                {
                    if (xhr2.readyState==4 && xhr2.status==200){
                        i18n = JSON.parse(xhr2.responseText);
                        initI18N();
                    }
                };
                xhr2.open('get','locale/en_US.json',true);
                xhr2.send();
            }
        }
    };
    xhr.open('get','locale/'+locale+'.json',true);
    xhr.send();





    function convert(){
        var result = kuroshiro.convert(document.getElementById("oritext").value,{to:document.getElementById("to").value,mode:document.getElementById("mode").value});
        document.getElementById("output").innerHTML = result;
    }

    function copytoclip(){
        clipboard.writeText(document.getElementById("output").innerHTML);
        showmsg(i18n["msg_resultcopied"]);
    }

    function savetofile(){
        dialog.showSaveDialog(function (fileName) {
            if (fileName === undefined) return;
            fs.writeFile(fileName, document.getElementById("output").innerHTML, function (err) {
                if(err)
                    showmsg(i18n["msg_erroroccurred"]);

                showmsg(i18n["msg_saved"]);
            });
        });
    }

    function showmsg(str){
        var e = document.getElementById("msgbox");
        e.innerHTML = str;
        e.addEventListener("animationend", function(){
            e.className = '';
        }, false);
        e.className = 'showmsg';
    }
</script>
</body>
</html>